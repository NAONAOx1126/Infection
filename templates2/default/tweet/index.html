<!--{include file="common/header.html"}-->
<meta name="loadmodule" content="Admin.Login" error="login.html" />
<meta name="loadmodule" content="Twitter.Account.Initialize" />
<meta name="loadmodule" content="Twitter.Setting.List" wkey="account_id" wvalue="0" force_operator="1" />
<meta name="loadmodule" content="Twitter.Account.Initialize" />
<meta name="loadmodule" content="Twitter.Account.InitializeGroup" default_all_groups="1" />
<meta name="loadmodule" content="Twitter.Account.InitializeOperator" default_all_operators="1" />
<meta name="loadmodule" content="Twitter.Account.Page" operator="list" adminRoles="administrator" _pager_per_page="30" _pager_displays="99" />
<meta name="loadmodule" content="Admin.Operator.List" mode="select" select="operator_id|operator_name" wkey="role_id" wvalue="2" />
<meta name="loadmodule" content="Twitter.Group.List" mode="select" select="group_id|group_name" />
<!--{include file="common/subheader.html"}-->
<div class="container-fluid">
    <div class="row-fluid">
        <div id="content" class="span12">
            <!-- content starts -->
            <!--{if $attr[VizualizerAdmin::KEY]->hasRole(array("administrator"))}-->
            <div class="box">
                <div class="box-header well">
                    <h2>
                        <i class="icon-list-alt"></i> Tweet共通設定
                    </h2>
                    <div class="box-icon">
                        <a href="#" class="btn btn-minimize btn-round" data-rel="popover" data-content="このブロックを最小化します" title="最小化" data-placement="left"><i class="icon-chevron-up"></i></a>
                    </div>
                </div>
                <!--{if is_array($ERRORS) && count($ERRORS) > 0}-->
                <div class="box-content alerts">
                    <!--{foreach from=$ERRORS item="error"}-->
                    <div class="alert alert-error">
                        <button type="button" class="close" data-dismiss="alert">×</button>
                        <!--{$error}-->
                    </div>
                    <!--{/foreach}-->
                </div>
                <!--{/if}-->
                <div class="box-content">
                    <form action="default_setting_complete.html" method="POST">
                    <!--{foreach from=$attr.settings item="setting"}-->
                    <input type="hidden" name="setting_id" value="<!--{$setting->setting_id}-->" />
                    <div class="form-group form-inline well">
                        ツイート条件
                        <input type="text" data-column="tweet_interval_0" class="form-control input-mini tweet_interval" name="tweet_interval" value="<!--{$setting->tweet_interval}-->" />分〜
                        <input type="text" data-column="max_tweet_interval_0" class="form-control input-mini max_tweet_interval" name="max_tweet_interval" value="<!--{$setting->max_tweet_interval}-->" />分間隔で
                        <input type="text" data-column="daytime_start_0" class="form-control input-mini daytime_start" name="daytime_start" value="<!--{$setting->daytime_start}-->" />時〜
                        <input type="text" data-column="daytime_end_0" class="form-control input-mini daytime_end" name="daytime_end" value="<!--{$setting->daytime_end}-->" />時までの間
                        <input type="text" data-column="daily_tweets_0" class="form-control input-mini daily_tweets" name="daily_tweets" value="<!--{$setting->daily_tweets}-->" />回までツイートする。<br />
                        BOT条件
                        <input type="text" data-column="bot_tweet_interval_0" class="form-control input-mini bot_tweet_interval" name="bot_tweet_interval" value="<!--{$setting->bot_tweet_interval}-->" />分〜
                        <input type="text" data-column="bot_max_tweet_interval_0" class="form-control input-mini bot_max_tweet_interval" name="bot_max_tweet_interval" value="<!--{$setting->bot_max_tweet_interval}-->" />分間隔で
                        <input type="text" data-column="bot_daytime_start_0" class="form-control input-mini bot_daytime_start" name="bot_daytime_start" value="<!--{$setting->bot_daytime_start}-->" />時〜
                        <input type="text" data-column="bot_daytime_end_0" class="form-control input-mini bot_daytime_end" name="bot_daytime_end" value="<!--{$setting->bot_daytime_end}-->" />時までの間
                        <input type="text" data-column="bot_daily_tweets_0" class="form-control input-mini bot_daily_tweets" name="bot_daily_tweets" value="<!--{$setting->bot_daily_tweets}-->" />回までツイートする。<br />
                        <label><input type="radio" data-column="tweet_order_0" class="form-control tweet_order" name="tweet_order" value="1"<!--{if $setting->tweet_order == "1"}--> checked<!--{/if}--> />登録順</label>
                        <label><input type="radio" data-column="tweet_order_0" class="form-control tweet_order" name="tweet_order" value="0"<!--{if $setting->tweet_order != "1"}--> checked<!--{/if}--> />ランダム</label>
                    </div>
                    <button type="submit" name="save" value="1" class="btn btn-default">設定する。</button>
                    <!--{/foreach}-->
                    </form>
                </div>
            </div>
            <!-- content ends -->
            <!--{/if}-->
            <div class="box">
                <div class="box-header well">
                    <h2>
                        <i class="icon-list-alt"></i> アカウント一覧
                    </h2>
                    <div class="box-icon">
                        <a href="#" class="btn btn-minimize btn-round" data-rel="popover" data-content="このブロックを最小化します" title="最小化" data-placement="left"><i class="icon-chevron-up"></i></a>
                    </div>
                </div>
                <div class="box-content">
                    <form action="index.html" method="GET">
                    <div>
                    <select id="selected_group" name="group_id">
                    <option value="">グループ指定なし</option>
                    <!--{html_options options=$attr.groups selected=$post.group_id}-->
                    </select>&nbsp;
                    <select id="selected_operator" name="operator_id">
                    <option value="">外注指定なし</option>
                    <!--{html_options options=$attr.operators selected=$post.operator_id}-->
                    </select>&nbsp;
                    <input type="text" name="search[part:screen_name]" value="<!--{$post["search"]["part:screen_name"]|default:""}-->" placeholder="IDで検索する" />&nbsp;
                    <input type="text" name="search[part:name]" value="<!--{$post["search"]["part:name"]|default:""}-->" placeholder="名前で検索する" />
                    <button type="submit" class="btn btn-default" name="exec_search" value="1">検索</button>
                    </div>
                    <div id="pagination pagination-centered">
                        <!--{$attr.accounts_pager->getPageLink()}-->
                    </div>
                    </form>
                    <table class="table table-condensed table-bordered table-striped">
                    <thead>
                    <tr>
                    <td width="100">アカウント</td>
                    <td width="100">実績</td>
                    <td width="100">Tweet状態</td>
                    <td width="200">最新ツイート</td>
                    <td width="200">外注用メモ</td>
                    </tr>
                    </thead>
                    <tbody>
                    <!--{foreach from=$attr.accounts item="account"}-->
                    <!--{assign var="followSetting" value=$account->followSetting()}-->
                    <!--{assign var="status" value=$account->status()}-->
                    <tr id="acc<!--{$account->account_id}-->">
                    <td>
                        <a href="https://twitter.com/<!--{$account->screen_name}-->" target="twitter"><!--{$account->name}--></a><br />（<!--{$account->screen_name}-->）<br />
                        <a href="https://twitter.com/<!--{$account->screen_name}-->" target="twitter"><img src="<!--{$account->profile_image_url}-->" width="50" /></a>
                        <br />
                        <a href="post.html?account_id=<!--{$account->account_id}-->" class="btn btn-success span10" target="postTweet">投稿</a>
                        <a href="log/index.html?search[account_id]=<!--{$account->account_id}-->" class="btn btn-success span10" target="postTweet">ツイートログ</a>
                        </td>
                    <td>
                        <div>ツイート数</div>
                        <div><span class="tweet_count"><!--{$account->tweet_count}--></span>投稿</div>
                        <div>フォロー数</div>
                        <div><span class="friend_count"><!--{$account->friend_count}--></span>人</div>
                        <div>フォロワー数</div>
                        <div><span class="follower_count"><!--{$account->follower_count}--></span>人</div>
                    </td>
                    <td>
                        <!--{assign var="preTweetCount" value=$account->getPreTweetCount()}-->
                        <div>残ツイート数</div>
                        <div><span class="pre_tweet_count"><!--{$preTweetCount}--></span>ツイート</div>
                        <div>BOTモード</div>
                        <div>
                            <a id="bot_status_<!--{$account->account_id}-->" class="bot_status"></a>
                        </div>
                        <div>ツイート状態</div>
                        <div><a id="tweet_status_<!--{$account->account_id}-->" class="tweet_status"></a></div>
                    </td>
                    <td style="white-space: normal">
                    <!--{assign var="lastTweet" value=$account->lastTweetLog()}-->
                    <div><!--{$lastTweet->getText()|nl2br}--></div>
                    <!--{if $lastTweet->getUrl() != ""}-->
                    <div><img src="<!--{$lastTweet->getUrl()}-->" style="max-width: 300px" /></div>
                    <!--{/if}-->
                    </td>
                    <td>
                    <div id="comment_<!--{$account->account_id}-->" class="comment"><!--{$account->comment}--></div>
                    </td>
                    </tr>
                    <!--{/foreach}-->
                    </tbody>
                    </table>
                    <div id="pagination pagination-centered">
                        <!--{$attr.accounts_pager->getPageLink()}-->
                    </div>
                </div>
            </div>
            <!-- content ends -->
        </div>
        <!--/#content.span10-->
    </div>
    <!--/fluid-row-->
    <hr>
    <!--{include file="common/subfooter.html"}-->
</div>
<!--/.fluid-container-->
<!--{include file="common/script.html"}-->
<script type="text/javascript">
$(function() {
    $('.comment').editable('<!--{base}-->/account/comment.html', {
        type : "textarea",
        rows : 4,
        indicator : 'Saving...',
        tooltip   : 'Click to edit...',
        submit  : '登録する'
    });
    $(".bot_status").click(function(){
		$this = $(this);
    	if(confirm("変更してもよろしいですか？")){
            $.ajax({
            	"type": "POST",
            	"url": "<!--{base}-->/twitter/AccountStatus.json",
            	"data": {
            		"target": $this.attr("id")
            	},
            	"dataType": "jsonp",
            	"success": function(data){
            		if(data.error !== void 0){
            			alert(data.error);
            		}else if(data.account_id > 0){
            			reload(data.account_id);
            		}
            	}
            });
    	}
    });
    $(".tweet_status").click(function(){
		$this = $(this);
    	if(confirm("変更してもよろしいですか？")){
            $.ajax({
            	"type": "POST",
            	"url": "<!--{base}-->/twitter/AccountStatus.json",
            	"data": {
            		"target": $this.attr("id"),
            	},
            	"dataType": "jsonp",
            	"success": function(data){
            		if(data.error !== void 0){
            			alert(data.error);
            		}else if(data.account_id > 0){
                        $.ajax({
                        	"type": "POST",
                        	"url": "<!--{base}-->/twitter/AccountStatus.json",
                        	"data": {
                        		"target": $this.attr("id").replace("tweet_status_", "original_status_"),
                        		"value": data.status.tweet_status
                        	},
                        	"dataType": "jsonp",
                        	"success": function(data){
                        		if(data.error !== void 0){
                        			alert(data.error);
                        		}else if(data.account_id > 0){
                        			reload(data.account_id);
                        		}
                        	}
                        });
            		}
            	}
            });
    	}
    });

   	reload = function(account_id){
   		if(account_id > 0){
   	        $.ajax({
   	        	"type": "POST",
   	        	"url": "<!--{base}-->/twitter/Account.json",
   	        	"data": {
   	        		"account_id": account_id
   	        	},
   	        	"dataType": "jsonp",
   	        	"success": function(data){
            		$status = $("<span />").addClass("label");
            		if(data.status.tweet_status == "1"){
            			$status.addClass("label-primary").text("ツイート稼働中");
   	        		}else{
            			$status.addClass("label-default").text("ツイート停止中");
            		}
            		$("#acc" + data.account_id + " .tweet_status").html($status[0]);
            		$status = $("<span />").addClass("label");
            		if(data.status.tweet_status == "1"){
            			$status.addClass("label-success").text("ツイート実行中");
   	        		}else{
            			$status.addClass("label-default").text("ツイート停止中");
            		}
            		$("#acc" + data.account_id + " .tweet_status").html($status[0]);

            		$status = $("<span />").addClass("label");
            		if(data.status.bot_status == "1"){
                		if(data.preTweetCount > 0){
                		    $status.addClass("label-success").text("BOTモードON");
                		}else{
                		    $status.addClass("label-warn").text("BOTモード有効");
                		}
   	        		}else{
            			$status.addClass("label-default").text("BOTモードOFF");
            		}
            		$("#acc" + data.account_id + " .bot_status").html($status[0]);

            		$("#acc" + data.account_id + " .pre_tweet_count").text(data.preTweetCount);
            		$("#acc" + data.account_id + " .tweet_count").text(data.status_count);
   	        		$("#acc" + data.account_id + " .friend_count").text(data.friend_count);
   	        		$("#acc" + data.account_id + " .follower_count").text(data.follower_count);
   	        	}
   	        });
   		}
    }
});
</script>
<!--{include file="common/footer.html"}-->
